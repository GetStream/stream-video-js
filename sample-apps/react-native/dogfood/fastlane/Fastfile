skip_docs
video_buddy_port = 7654
metro_port = 8081
build_dir = 'dist'
bundle_id = 'io.getstream.rnvideosample'
bundle_id_broadcast = 'io.getstream.rnvideosample.Broadcast-Extension'
provisioning_profile_prefix = 'match AppStore '
android_package_name = 'io.getstream.rnvideosample'

private_lane :latest_googleplay_version_code do |options|
  tracks = ["internal", "alpha", "beta", "production"]
  version_codes = []
  tracks.each do |track|
    vc = google_play_track_version_codes(
      package_name: android_package_name,
      json_key: ENV.fetch('RN_DOGFOOD_ANDROID_DEPLOY_SERVICE_ACCOUNT', nil),
      track: track
    )
  rescue StandardError
    puts("No google play release found for track: #{track}")
  else
    version_codes.concat(vc)
  end
  version_codes.max
end

private_lane :latest_appstore_version_code do |options|
  livestates = [true, false]
  version_codes = []
  livestates.each do |livestate|
    vc = app_store_build_number(
      live: livestate,
      app_identifier: bundle_id
    )
  rescue StandardError
    puts("No app store build found for liveState: #{livestate} bundle_id: #{bundle_id}")
  else
    version_codes.append(vc)
  end
  version_codes.max
end

before_all do
  if is_ci
    setup_ci
    ENV['FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT'] = '180'
  end
end

desc 'Installs all Certs and Profiles necessary for appstore'
lane :match_appstore do
  match(
    type: 'appstore',
    app_identifier: [bundle_id, bundle_id_broadcast],
    readonly: is_ci
  )
end

lane :rubocop do
  sh('bundle exec rubocop')
end

lane :start_video_buddy do
  sh('stream-video-buddy auth')
  sh('node ../e2e/js/server.js > video-buddy-log.txt 2>&1 &')
end

lane :stop_video_buddy do
  sh("lsof -t -i:#{video_buddy_port} | xargs kill -s INT || true")
end

lane :stop_metro do
  sh("lsof -t -i:#{metro_port} | xargs kill -s INT || true")
end

lane :load_package do
  load_json(json_path: 'package.json')
end

lane :pod_install do
  Dir.chdir('../ios') do
    sh('bundle exec pod install')
  rescue StandardError # Due this error https://github.com/facebook/react-native/issues/36945#issuecomment-1556230597
    retry_count = 0
    success = false
    until success
      begin
        sh('bundle exec pod update hermes-engine --no-repo-update')
        success = true
      rescue StandardError => e
        retry_count += 1
        UI.user_error!(e) if retry_count > 2
      end
    end
  end
end

lane :bump_ios_version_number do
  increment_version_number(
    version_number: load_package['version'],
    xcodeproj: 'ios/StreamReactNativeVideoSDKSample.xcodeproj'
  )

  current_build_number = latest_appstore_version_code

  puts("Current build number: #{current_build_number}")

  increment_build_number(
    build_number: current_build_number + 1,
    xcodeproj: 'ios/StreamReactNativeVideoSDKSample.xcodeproj'
  )
end

lane :build_ios do
  app_store_connect_api_key

  ENV['NODE_ENV'] = 'production'

  bump_ios_version_number if is_ci

  match_appstore

  gym(
    workspace: 'ios/StreamReactNativeVideoSDKSample.xcworkspace',
    scheme: 'StreamReactNativeVideoSDKSample',
    export_method: 'app-store',
    silent: true,
    clean: true,
    export_options: {
      provisioningProfiles: {
        bundle_id => provisioning_profile_prefix + bundle_id,
        bundle_id_broadcast => provisioning_profile_prefix + bundle_id_broadcast
      }
    },
    include_symbols: true,
    output_directory: build_dir
  )

  Dir.chdir('..') do
    sh("mkdir -p #{build_dir} && mv -f #{lane_context[SharedValues::IPA_OUTPUT_PATH]} #{build_dir}/app.ipa")
  end
end

lane :test_ios do |options|
  start_video_buddy

  udid = prepare_simulator(device: 'iPhone 14 Pro')

  unless options[:skip_install]
    app = build_app_for_ios_simulator(
      scheme: 'StreamReactNativeVideoSDKSample',
      workspace: 'ios/StreamReactNativeVideoSDKSample.xcworkspace',
      configuration: 'Release',
      output_directory: build_dir
    )
    sh("xcrun simctl install #{udid} #{app}")
  end

  Dir.chdir('..') do
    # Record simulator screen using codec h264
    sh("xcrun simctl io #{udid} recordVideo --codec h264 --force fastlane/video.mp4 > fastlane/recording.log 2>&1 &")
    # Record simulator log in compact style
    sh("xcrun simctl spawn #{udid} log stream --style compact > fastlane/device.log 2>&1 &")

    sh('maestro test e2e/test.yaml')
  ensure
    `pgrep simctl`.strip.split("\n").each { |pid| sh("kill -s INT #{pid} || true") }
    sh('maestro hierarchy > fastlane/hierarchy.json || true')
    [
      'recording.log',
      'hierarchy.json',
      'device.log',
      'video.mp4'
    ].each { |f| sh("mv -f fastlane/#{f} ~/.maestro/tests || true") } if is_ci
    stop_video_buddy
    stop_metro
  end
end

lane :deploy_ios do
  upload_to_testflight(
    api_key: app_store_connect_api_key,
    ipa: "#{build_dir}/app.ipa",
    groups: ['Dev Testers', 'Stream Testers'],
    changelog: 'Lots of amazing new features to test out!',
    reject_build_waiting_for_review: true,
    distribute_external: true,
    skip_waiting_for_build_processing: false
  )
rescue StandardError => e
  UI.user_error!(e) unless e.message.include?('Another build is in review')

  UI.important('Another build is already in beta review. Skipping beta review submission')
end

lane :bump_android_version_number_play_store do
  latest_app_distribution_version_code = latest_googleplay_version_code

  increment_version_code(
    gradle_file_path: 'android/app/build.gradle',
    version_code: latest_app_distribution_version_code + 1
  )

  increment_version_name(
    gradle_file_path: 'android/app/build.gradle',
    version_name: load_package['version']
  )
end

lane :build_android_play_store do
  ENV['NODE_ENV'] = 'production'

  bump_android_version_number_play_store if is_ci

  gradle(
    project_dir: 'android',
    print_command: false,
    tasks: ["clean", "assembleRelease", "bundleRelease"],
    properties: {
      "android.injected.signing.store.file" => ENV.fetch('RN_DOGFOOD_ANDROID_KEYSTORE', nil),
      "android.injected.signing.store.password" => ENV.fetch('RN_DOGFOOD_ANDROID_KEYSTORE_PASSWORD', nil),
      "android.injected.signing.key.alias" => ENV.fetch('RN_DOGFOOD_ANDROID_KEYSTORE_ALIAS', nil),
      "android.injected.signing.key.password" => ENV.fetch('RN_DOGFOOD_ANDROID_KEYSTORE_PASSWORD', nil)
    }
  )

  Dir.chdir('..') do
    sh("mkdir -p #{build_dir} && mv -f #{lane_context[SharedValues::GRADLE_AAB_OUTPUT_PATH]} #{build_dir}/app.aab && mv -f #{lane_context[SharedValues::GRADLE_APK_OUTPUT_PATH]} #{build_dir}/app.apk")
  end
end

lane :test_android do |options|
  build_android_play_store unless is_ci || options[:skip_install]

  start_video_buddy

  wait_android_emu_idle(load_threshold: 1, timeout: 2200) if is_ci

  emulator_status = -> { sh('adb devices').include?('emulator') }

  Dir.chdir('..') do
    unless options[:skip_install]
      sh("adb uninstall #{$bundle_id} >/dev/null || true")
      sh("adb install #{build_dir}/app.apk")
    end

    sh('adb logcat -c || true') if emulator_status.call

    # Record emulator screen using codec h264
    # adb limits the recording to 3 minutes, so we bypass this by redirecting the stream to ffmpeg tool
    video_group_pid = Process.spawn('adb shell "while true; do screenrecord --output-format=h264 -; done" | ' \
                                    'ffmpeg -y -i - fastlane/video.mp4 > fastlane/recording.log 2>&1 &', pgroup: true)
    video_pid = `pgrep -g #{Process.getpgid(video_group_pid)}`.split.map(&:to_i).first

    sh('maestro test e2e/test.yaml')
  ensure
    sh("kill -s INT #{video_pid} || true")
    sh('adb logcat -d > fastlane/device.log || true') if emulator_status.call
    sh('maestro hierarchy > fastlane/hierarchy.json || true')
    [
      'recording.log',
      'hierarchy.json',
      'device.log',
      'video.mp4'
    ].each { |f| sh("mv -f fastlane/#{f} ~/.maestro/tests || true") } if is_ci
    stop_video_buddy
    stop_metro
  end
end

lane :deploy_android_play_store do
  supply(
    track: "internal",
    package_name: android_package_name,
    json_key: ENV.fetch('RN_DOGFOOD_ANDROID_DEPLOY_SERVICE_ACCOUNT', nil),
    aab: "#{build_dir}/app.aab"
  )
end
