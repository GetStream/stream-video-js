---
title: Push Notification
sidebar_position: 2
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import ImageShowcase from '@site/src/components/ImageShowcase';
import iosCallkitLibrariesLinkImage from '../assets/ios-callkit-libraries-link.png';
import iosSearchPaths from '../assets/ios-search-paths.png'
import iosInfoPlist from '../assets/ios-info-plist.png'


## Setup

1. Install the following modules to work with Firebase Cloud Messaging (FCM).

<Tabs groupId="package-manager">
  <TabItem value="Yarn" default>

```bash
  yarn add @react-native-firebase/app
  yarn add @react-native-firebase/messaging
  yarn add react-native-callkeep
  yarn add react-native-voip-push-notification
  npx pod-install
```

  </TabItem>
  <TabItem value="npm">

```bash
  npm install @react-native-firebase/app
  npm install @react-native-firebase/messaging
  npm install react-native-callkeep
  npm install react-native-voip-push-notification
  npx pod-install
```
  </TabItem>
</Tabs>

2. [Generate credentials for your Android app and configure Firebase](https://rnfirebase.io/#2-android-setup).
3. [Generate credentials for your iOS app and configure Firebase](https://rnfirebase.io/#2-iOS-setup).

## iOS specific setup

### Link required libraries for react native callkeep library

1. In Xcode: Click on `Build Phases` tab, then open `Link Binary With Libraries`.
2. Add `CallKit.framework` and `Intents.framework` (and mark it Optional).

<ImageShowcase
  items={[
    {
      image: iosCallkitLibrariesLinkImage,
      caption: (
        <span>
          Add <code>CallKit.framework</code> and <code>Intents.framework</code> (and mark it Optional).
        </span>
      ),
      alt: 'Example of how to use link libraries required for callkeep library',
    }
  ]}
/>

### Add header search path

1. In Xcode: Click on `Build Settings` tab, then search for `Header Search Paths`.

2. Add `$(SRCROOT)/../node_modules/react-native-callkeep/ios/RNCallKeep`.

<ImageShowcase
  items={[
    {
      image: iosSearchPaths,
      caption: (
        <span>
          Add <code>$(SRCROOT)/../node_modules/react-native-callkeep/ios/RNCallKeep</code>
        </span>
      ),
      alt: 'Example of how to add header search paths that are required for callkeep library',
    }
  ]}
/>

### Allow voip background

1. In Xcode: Open `Info.plist` file and add `voip` in `UIBackgroundModes`. As shown below:

<ImageShowcase
  items={[
    {
      image: iosInfoPlist,
      alt: 'Example of how to add voip in Info.plist',
    }
  ]}
/>

By editing this file with a text editor, you should see:

```xml
<key>UIBackgroundModes</key>
<array>
  <string>voip</string>
</array>
```

### Update AppDelegate

Update `AppDelegate.m` or `AppDelegate.mm` in Xcode with the following lines for iOS support.

```c
// highlight-start
#import <Firebase.h>
#import "RNCallKeep.h"
#import <PushKit/PushKit.h>
#import "RNVoipPushNotificationManager.h"
// highlight-end

@implementation AppDelegate

- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions
{
  // highlight-next-line
  [FIRApp configure];

  RCTBridge *bridge = [[RCTBridge alloc] initWithDelegate:self launchOptions:launchOptions];

  // highlight-next-line
  [RNVoipPushNotificationManager voipRegistration];

  // the rest
}

- (BOOL)application:(UIApplication *)application
 continueUserActivity:(nonnull NSUserActivity *)userActivity
   restorationHandler:(nonnull void (^)(NSArray<id<UIUserActivityRestoring>> * _Nullable))restorationHandler
{
  return [RNCallKeep application:application
                    continueUserActivity:userActivity
                      restorationHandler:restorationHandler];
}

// Handle updated push credentials
- (void)pushRegistry:(PKPushRegistry *)registry didUpdatePushCredentials:(PKPushCredentials *)credentials forType:(PKPushType)type {
  // Fire 'register' event to JS
  [RNVoipPushNotificationManager didUpdatePushCredentials:credentials forType:(NSString *)type];
}

// Handle incoming pushes
- (void)pushRegistry:(PKPushRegistry *)registry didReceiveIncomingPushWithPayload:(PKPushPayload *)payload forType:(PKPushType)type withCompletionHandler:(void (^)(void))completion {

   // fire 'notification' event to JS
   [RNVoipPushNotificationManager didReceiveIncomingPushWithPayload:payload forType:(NSString *)type];
  
   // Retrieve information from your stream's push payload
   NSDictionary *stream = payload.dictionaryPayload[@"stream"];
   NSString *callCid = stream[@"call_cid"];
  
   // construct a random uuid // TODO: may be call_cid is enough
   NSUUID* uuid = [NSUUID alloc];
   NSString* uuidString = [uuid UUIDString];
   NSString *userIds = stream[@"user_ids"];

  // report to callkeep to show native incoming call view
  [RNCallKeep reportNewIncomingCall: uuidString
                             handle: @"handle_no"
                         handleType: @"generic"
                           hasVideo: NO
                localizedCallerName: userIds
                    supportsHolding: YES
                       supportsDTMF: YES
                   supportsGrouping: YES
                 supportsUngrouping: YES
                        fromPushKit: YES
                            payload: stream
              withCompletionHandler: completion];
}
```

## Android specific setup

### Add permissions

In `android/app/src/main/AndroidManifest.xml` add these permissions:

```xml
<uses-permission android:name="android.permission.BIND_TELECOM_CONNECTION_SERVICE"/>
<uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
<uses-permission android:name="android.permission.READ_PHONE_STATE" />
<uses-permission android:name="android.permission.CALL_PHONE" />
<uses-permission android:name="android.permission.RECORD_AUDIO" />

<application>
    <service android:name="io.wazo.callkeep.VoiceConnectionService"
        android:label="Wazo"
        android:permission="android.permission.BIND_TELECOM_CONNECTION_SERVICE"
        android:foregroundServiceType="camera|microphone"
    >
        <intent-filter>
            <action android:name="android.telecom.ConnectionService" />
        </intent-filter>
    </service>
</application>
```

### Handle incoming push payload

Add the following function in your codebase to process the incoming push payload from stream and to show an incoming call view

```ts
import messaging, {
  FirebaseMessagingTypes,
} from '@react-native-firebase/messaging';

import RNCallKeep from 'react-native-callkeep';

function setFirebaseHandler() {
  const firebaseListener = async (
    message: FirebaseMessagingTypes.RemoteMessage,
  ) => {
    const uuidStr = message.data?.call_cid; // a random id
    if (!uuidStr) return
    const localizedCallerName = message.data?.user_names ?? '';
    const handle = 'handle'; // Phone number of the caller
    const handleType = 'generic'; // ios only
    const hasVideo = true; // ios only
    RNCallKeep.displayIncomingCall(
      uuidStr,
      handle,
      localizedCallerName,
      handleType,
      hasVideo,
    );
  };
  messaging().setBackgroundMessageHandler(firebaseListener);
  messaging().onMessage(firebaseListener);
  messaging()
    .getToken()
    .then((token) => {
      // TODO: send token to stream
      console.log({ token });
    });
}

setFirebaseHandler() // call this in the entry point of your app (index.js or equivalent)
```

## Handle events from callkeep

TODO: move a lot of this stuff into SDK

```ts
import { useEffect } from 'react';
import { PermissionsAndroid } from 'react-native';
import RNCallKeep from 'react-native-callkeep';
import { BehaviorSubject } from 'rxjs';
import {
  RunStaticNavigation,
  StaticNavigationService,
} from '../utils/staticNavigationUtils';

const options: Parameters<typeof RNCallKeep.setup>[0] = {
  ios: {
    appName: 'ReactNativeStreamDogFood',
    supportsVideo: true,
  },
  android: {
    alertTitle: 'Permissions Required',
    alertDescription:
      'This application needs to access your phone calling accounts to make calls',
    cancelButton: 'Cancel',
    okButton: 'ok',
    // Required to get audio in background when using Android 11
    foregroundService: {
      channelId: 'com.company.my',
      channelName: 'Foreground service for my app',
      notificationTitle: 'My app is running on background',
      notificationIcon: 'Path to the resource icon of the notification',
    },
  },
};

try {
  RNCallKeep.setup(options);
  RNCallKeep.setAvailable(true); // TODO: set true/false based on login/logout
} catch (err) {
  console.error('initializeCallKeep error:', err);
}

export const callkeepCallId$ = new BehaviorSubject<string | undefined>(
  undefined,
);

export const useCallKeepEffect = () => {
  useEffect(() => {
    RNCallKeep.addEventListener('answerCall', ({ callUUID }) => {
      console.log('answerCall', { callUUID });
      RNCallKeep.backToForeground();
      // close the dialer screen so that the app can be seen (only android needs this)
      RNCallKeep.endCall(callUUID);

      RunStaticNavigation(() => {
        callkeepCallId$.next(callUUID);
        StaticNavigationService.navigate('CallScreen');
      });
    });
    RNCallKeep.addEventListener('endCall', ({ callUUID }) => {
      if (callUUID) {
        RNCallKeep.endCall(callUUID);
      }
    });

    return () => {
      RNCallKeep.removeEventListener('answerCall');
      RNCallKeep.removeEventListener('endCall');
    };
  }, []);
};

```